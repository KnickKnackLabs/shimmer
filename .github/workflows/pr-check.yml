name: PR Check

on:
  pull_request:
    branches: [main]

jobs:
  check-workflow-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for workflow file changes
        run: |
          # Get list of changed files in this PR
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          WORKFLOW_FILES=$(echo "$CHANGED_FILES" | grep '^\.github/workflows/' || true)

          if [ -n "$WORKFLOW_FILES" ]; then
            echo "::warning::⚠️ This PR modifies workflow files - requires careful review"
            echo ""
            echo "Changed workflow files:"
            echo "$WORKFLOW_FILES" | while read -r file; do
              echo "  - $file"
            done
            echo ""
            echo "Please verify:"
            echo "  - No infinite loop triggers"
            echo "  - No privilege escalation (new secrets access, permissions)"
            echo "  - Changes are intentional and reviewed"
          fi

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up mise
        uses: jdx/mise-action@v2
        with:
          install: true

      - name: Cache Elixir build
        uses: actions/cache@v4
        with:
          path: |
            shimmer-cli/_build
            shimmer-cli/deps
          key: ${{ runner.os }}-elixir-${{ hashFiles('shimmer-cli/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-elixir-

      - name: Install dependencies
        run: |
          cd shimmer-cli
          mix local.hex --force
          mix deps.get

      - name: Run tests
        run: |
          cd shimmer-cli
          mix test

      - name: Check formatting
        run: |
          cd shimmer-cli
          mix format --check-formatted

      - name: Run Credo linter
        run: |
          cd shimmer-cli
          mix credo
