#!/usr/bin/env bash
#MISE description="Setup GPG signing for an agent (one-time local setup)"
#USAGE arg "<agent>" help="Agent name (e.g., quick, x1f9)"

set -e

AGENT="${1:?Usage: mise run gpg:setup <agent>}"
EMAIL="${AGENT}@ricon.family"

# Check if gpg is available
if ! command -v gpg &> /dev/null; then
  echo "ERROR: gpg command not found. Please install GnuPG."
  exit 1
fi

# Import key if not already present
if gpg --list-secret-keys "$EMAIL" &>/dev/null; then
  echo "GPG key for $EMAIL already imported"
else
  # Get private key: env var > 1Password > error
  if [ -z "$GPG_PRIVATE_KEY" ]; then
    if command -v op &> /dev/null && op account get &> /dev/null; then
      echo "Fetching GPG key from 1Password..."
      # 1Password returns the key with quotes, strip them
      GPG_PRIVATE_KEY=$(op item get "${AGENT} - GPG" --vault Agents --fields "Private Key" --reveal 2>/dev/null | tr -d '"' || true)
      if [ -n "$GPG_PRIVATE_KEY" ]; then
        echo "Using key from 1Password"
      fi
    fi
  fi

  if [ -z "$GPG_PRIVATE_KEY" ]; then
    echo "ERROR: Could not get GPG key for $AGENT"
    echo ""
    echo "Options:"
    echo "  1. Sign into 1Password: op signin"
    echo "  2. Set GPG_PRIVATE_KEY env var manually"
    exit 1
  fi

  # Import the private key
  echo "Importing GPG key for $EMAIL..."
  echo "Key length: ${#GPG_PRIVATE_KEY} chars"
  echo "First line: $(echo "$GPG_PRIVATE_KEY" | head -1)"
  echo "Number of lines: $(echo "$GPG_PRIVATE_KEY" | wc -l)"
  if [ ${#GPG_PRIVATE_KEY} -lt 100 ]; then
    echo "ERROR: GPG_PRIVATE_KEY seems too short or empty"
    exit 1
  fi

  # Write to temp file and import (more reliable than piping)
  TMPKEY=$(mktemp)
  echo "$GPG_PRIVATE_KEY" > "$TMPKEY"
  gpg --batch --import "$TMPKEY"
  rm -f "$TMPKEY"

  # Trust the key (so gpg doesn't complain about untrusted key)
  echo -e "5\ny\n" | gpg --batch --command-fd 0 --expert --edit-key "$EMAIL" trust quit 2>/dev/null || true
fi

# Get the key ID (single location, after import if needed)
KEY_ID=$(gpg --list-secret-keys --keyid-format LONG "$EMAIL" 2>/dev/null | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)

if [ -z "$KEY_ID" ]; then
  echo "ERROR: Could not find key ID for $EMAIL"
  exit 1
fi

# Write per-agent gitconfig
AGENT_DIR="$HOME/agents/$AGENT"
AGENT_GITCONFIG="$AGENT_DIR/.gitconfig"
mkdir -p "$AGENT_DIR"

cat > "$AGENT_GITCONFIG" <<GITCONFIG
[user]
	name = $AGENT
	email = $EMAIL
	signingkey = $KEY_ID
[commit]
	gpgsign = true
[tag]
	gpgsign = true
GITCONFIG

echo "Wrote $AGENT_GITCONFIG"

# Add includeIf to global gitconfig if not already present
INCLUDE_PATH="includeIf \"gitdir:~/agents/$AGENT/\""
if ! git config --global --get-regexp 'includeIf' 2>/dev/null | grep -q "agents/$AGENT/"; then
  git config --global --add "includeIf.gitdir:~/agents/$AGENT/.path" "$AGENT_GITCONFIG"
  echo "Added conditional include to global gitconfig"
else
  echo "Conditional include already present in global gitconfig"
fi

echo ""
echo "GPG configured for $EMAIL"
echo "  Key ID: $KEY_ID"
echo "  Config: $AGENT_GITCONFIG"
echo "  Scope:  repos under ~/agents/$AGENT/"
echo ""
echo "Test with: cd ~/agents/$AGENT/<repo> && git commit --allow-empty -m 'Test signed commit'"
