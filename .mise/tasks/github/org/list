#!/usr/bin/env bash
#MISE description="List your organizations with details"
set -eo pipefail

# Auth check
if [ -z "$GH_TOKEN" ] && ! gh auth status &>/dev/null; then
  echo "ERROR: Not authenticated with GitHub" >&2
  echo "Run: eval \$(shimmer as <agent>)" >&2
  exit 1
fi

MEMBERSHIPS=$(gh api "/user/memberships/orgs?state=active" --jq '.[].organization.login' 2>/dev/null || true)

if [[ -z "$MEMBERSHIPS" ]]; then
  echo "Not a member of any organizations."
  exit 0
fi

echo "Organizations:"
echo ""

TOTAL=0
while IFS= read -r org; do
  TOTAL=$((TOTAL + 1))
  INFO=$(gh api "/orgs/$org" --jq '{description, public_repos, total_private_repos}' 2>/dev/null || echo '{}')
  ROLE=$(gh api "/user/memberships/orgs/$org" --jq '.role' 2>/dev/null || echo "member")
  MEMBERS=$(gh api "/orgs/$org/members" --jq 'length' 2>/dev/null || echo "0")

  DESC=$(echo "$INFO" | jq -r '.description // empty')
  PUBLIC_REPOS=$(echo "$INFO" | jq -r '.public_repos // 0')
  PRIVATE_REPOS=$(echo "$INFO" | jq -r '.total_private_repos // 0')
  REPO_COUNT=$((PUBLIC_REPOS + PRIVATE_REPOS))

  printf "  %-24s %-8s %3d repos  %3d members" "$org" "$ROLE" "$REPO_COUNT" "$MEMBERS"
  if [[ -n "$DESC" ]]; then
    echo "  $DESC"
  else
    echo ""
  fi
done <<< "$MEMBERSHIPS"

echo ""
echo "Total: $TOTAL organizations"
