#!/usr/bin/env bash
#MISE description="Provision a new agent (GPG key, GitHub secrets, 1Password)"
#USAGE arg "<agent-name>" help="Name of the agent to provision"
#USAGE flag "--force" help="Regenerate existing GPG key"

set -e

AGENT="${usage_agent_name:?Usage: mise run agent:provision <agent-name> [--force]}"
FORCE="${usage_force:-}"
EMAIL="${AGENT}@ricon.family"
UPPER=$(echo "$AGENT" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
VAULT="Agents"

# Target caller's repo for GitHub secrets (not shimmer's)
TARGET_DIR="${PROJECT_DIR:-${CALLER_PWD:-.}}"
cd "$TARGET_DIR"

echo "=== Provisioning agent: $AGENT ==="
echo ""

# Check prerequisites
if ! gpg --list-keys admin@ricon.family >/dev/null 2>&1; then
  echo "ERROR: Org key (admin@ricon.family) not found in keyring."
  exit 1
fi

if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found."
  exit 1
fi

if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin"
  exit 1
fi

# === GPG Key ===
echo "--- GPG Key ---"
GPG_NEWLY_GENERATED=false

if gpg --list-keys "$EMAIL" >/dev/null 2>&1; then
  echo "[auto] Key for $EMAIL already in keyring"
  if [ "$FORCE" = "true" ]; then
    echo "[auto] --force: regenerating key..."
    EXISTING_FP=$(gpg --list-keys --keyid-format LONG "$EMAIL" | grep -A1 "^pub" | tail -1 | tr -d ' ')
    gpg --batch --yes --delete-secret-and-public-key "$EXISTING_FP" 2>/dev/null || true
  fi
fi

if ! gpg --list-keys "$EMAIL" >/dev/null 2>&1; then
  # 1Password is the source of truth — import from there first
  STORED_PRIVATE_KEY=$(op item get "${AGENT} - GPG" --vault "$VAULT" --fields "Private Key" 2>/dev/null || echo "")
  if [[ -n "$STORED_PRIVATE_KEY" ]]; then
    echo "[auto] Importing GPG key from 1Password..."
    echo "$STORED_PRIVATE_KEY" | gpg --batch --import 2>&1 | grep -v "^gpg: Total" || true
  else
    echo "[auto] Generating new GPG key for $EMAIL..."
    gpg --batch --gen-key << KEYSPEC
Key-Type: RSA
Key-Length: 4096
Name-Real: $AGENT
Name-Email: $EMAIL
Expire-Date: 0
%no-protection
%commit
KEYSPEC
    GPG_NEWLY_GENERATED=true
  fi
fi

# Sign with org key (idempotent — re-signing is a no-op)
FINGERPRINT=$(gpg --list-keys --keyid-format LONG "$EMAIL" | grep -A1 "^pub" | tail -1 | tr -d ' ')
echo "[auto] Signing with org key..."
gpg --batch --yes --no-tty --local-user admin@ricon.family --quick-sign-key "$FINGERPRINT" 2>&1 || true

# === GitHub Secrets ===
echo ""
echo "--- GitHub Secrets ---"
echo "[auto] Storing ${UPPER}_GPG_PRIVATE_KEY..."
gpg --armor --export-secret-keys "$EMAIL" | gh secret set "${UPPER}_GPG_PRIVATE_KEY"
echo "[auto] Storing ${UPPER}_GPG_PUBLIC_KEY..."
gpg --armor --export "$EMAIL" | gh secret set "${UPPER}_GPG_PUBLIC_KEY"

# === 1Password ===
echo ""
echo "--- 1Password ---"

KEY_ID=$(gpg --list-keys --keyid-format LONG "$EMAIL" | grep "^pub" | awk '{print $2}' | cut -d'/' -f2)
PRIVATE_KEY=$(gpg --armor --export-secret-keys "$EMAIL" 2>/dev/null)
PUBLIC_KEY=$(gpg --armor --export "$EMAIL" 2>/dev/null)

item_exists() {
  op item get "$1" --vault "$VAULT" &> /dev/null
}

ensure_item() {
  local title="$1"; shift
  if item_exists "$title"; then
    echo "[auto] $title already exists"
    return 1  # signal: already existed
  else
    echo "[auto] Creating $title..."
    op item create --title "$title" --vault "$VAULT" "$@" > /dev/null
    return 0  # signal: newly created
  fi
}

# Email item
ensure_item "${AGENT} - Email" \
  --category login \
  --url "https://mail.ricon.family" \
  username="$AGENT" \
  "email[text]=$EMAIL" \
  --generate-password=20,letters,digits || true

# GitHub item
ensure_item "${AGENT} - GitHub" \
  --category login \
  --url "https://github.com" \
  username="${AGENT}-ricon" \
  "email[text]=$EMAIL" \
  "country[text]=United States of America" \
  --generate-password=20,letters,digits || true

# Matrix item
ensure_item "${AGENT} - Matrix" \
  --category login \
  --url "https://matrix.ricon.family" \
  username="@${AGENT}:ricon.family" \
  --generate-password=20,letters,digits || true

# Identity item (with admin override passphrase)
if ! item_exists "${AGENT} - Identity"; then
  echo "[auto] Creating ${AGENT} - Identity..."
  WORD1=$(shuf -n1 /usr/share/dict/words | tr '[:lower:]' '[:upper:]')
  WORD2=$(shuf -n1 /usr/share/dict/words | tr '[:lower:]' '[:upper:]')
  PASSPHRASE="$WORD1 $WORD2"
  op item create \
    --category "Secure Note" \
    --title "${AGENT} - Identity" \
    --vault "$VAULT" \
    "passphrase[password]=$PASSPHRASE" \
    "notes[text]=Admin override passphrase for $AGENT. Used by shimmer --passphrase flag." > /dev/null
else
  echo "[auto] ${AGENT} - Identity already exists"
fi

# GPG item — only write to 1Password when key was newly generated
if [[ "$GPG_NEWLY_GENERATED" == "true" ]]; then
  if item_exists "${AGENT} - GPG"; then
    echo "[auto] Updating ${AGENT} - GPG..."
    op item edit "${AGENT} - GPG" --vault "$VAULT" \
      "Key ID[text]=$KEY_ID" \
      "Fingerprint[text]=$FINGERPRINT" \
      "Email[text]=$EMAIL" \
      "Private Key[text]=$PRIVATE_KEY" \
      "Public Key[text]=$PUBLIC_KEY" \
      "GitHub Title[text]=$EMAIL" > /dev/null
  else
    echo "[auto] Creating ${AGENT} - GPG..."
    op item create \
      --category "Secure Note" \
      --title "${AGENT} - GPG" \
      --vault "$VAULT" \
      "Key ID[text]=$KEY_ID" \
      "Fingerprint[text]=$FINGERPRINT" \
      "Email[text]=$EMAIL" \
      "Private Key[text]=$PRIVATE_KEY" \
      "Public Key[text]=$PUBLIC_KEY" \
      "GitHub Title[text]=$EMAIL" > /dev/null
  fi
else
  echo "[auto] ${AGENT} - GPG unchanged (key not regenerated)"
fi

echo ""
echo "=== $AGENT provisioned ==="
echo ""
echo "Next: mise run agent:onboard $AGENT"
